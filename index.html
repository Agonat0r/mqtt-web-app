<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USF Harmar MQTT Console</title>

  <!-- 🌐 Styles -->
  <link rel="stylesheet" href="styles.css" />

  <!-- 📡 MQTT via WebSocket -->
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>

  <!-- 📧 EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  <!-- 🔐 Login Screen -->
  <div id="login-screen">
    <h1>🔐 USF Harmar MQTT Login</h1>
    <input type="text" id="login-username" placeholder="Username" />
    <input type="password" id="login-password" placeholder="Password" />
    <button onclick="handleLogin()">Login</button>
  </div>

  <!-- 📡 Main App -->
  <div id="main-app" class="hidden">
    <div class="navbar">
      <div class="nav-title">USF Harmar Dashboard</div>
      <div class="nav-tabs">
        <button onclick="switchTab('general')">General</button>
        <button onclick="switchTab('commands')">Commands</button>
        <button onclick="switchTab('alerts')">Alerts</button>
      </div>
    </div>

    <div class="tab-content" id="general-tab">
      <h2>📋 General Console</h2>
      <pre id="general-log">Waiting for general messages...</pre>
    </div>

    <div class="tab-content hidden" id="commands-tab">
      <h2>🧠 Command Console</h2>
      <pre id="command-log">Waiting for commands...</pre>
    </div>

    <div class="tab-content hidden" id="alerts-tab">
      <h2>🚨 Alert Console</h2>
      <pre id="alert-log">Waiting for alerts...</pre>
    </div>

    <div class="tools-panel">
      <select id="language-selector" onchange="switchLanguage()">
        <option value="en">🌐 English</option>
        <option value="es">🌐 Español</option>
      </select>

      <input type="email" id="user-email" placeholder="Enter your email" />
      <button onclick="sendEmail()">📤 Send Report</button>

      <select id="file-format">
        <option value="txt">.txt</option>
        <option value="csv">.csv</option>
      </select>
      <button onclick="exportLogs()">💾 Export Logs</button>
    </div>
  </div>

  <!-- 📧 Hidden Form for EmailJS -->
  <form id="email-form" style="display: none;">
    <input type="text" name="title" />
    <input type="text" name="name" />
    <input type="text" name="time" />
    <input type="hidden" name="message" />
    <input type="email" name="to_email" />
  </form>

  <!-- 📜 JavaScript Logic -->
  <script>
    function handleLogin() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      if (username === 'admin' && password === 'mqtt2025') {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        connectToMQTT();
      } else {
        alert('❌ Invalid credentials');
      }
    }

    let client;
    const host = "10.226.176.234";
    const port = 8083;
    const path = "/mqtt";
    const topic = "usf/messages";

    function connectToMQTT() {
      const clientId = "webClient_" + Math.random().toString(16).substr(2, 8);
      client = new Paho.MQTT.Client(host, Number(port), path, clientId);

      client.onMessageArrived = onMessageArrived;
      client.onConnectionLost = () => logToAll("🔌 Connection lost");

      client.connect({
        userName: "admin",
        password: "mqtt2025",
        onSuccess: () => {
          logToAll("✅ Connected to MQTT broker");
          client.subscribe(topic);
          logToAll("🔔 Subscribed to topic: " + topic);
        },
        onFailure: (err) => {
          logToAll("❌ MQTT connect failed: " + err.errorMessage);
        }
      });
    }

    function onMessageArrived(message) {
      const msg = message.payloadString;
      if (msg.startsWith("E")) log("command-log", "🧠 " + msg);
      else if (msg.toLowerCase().includes("alert")) log("alert-log", "🚨 " + msg);
      else log("general-log", "📩 " + msg);
    }

    function log(id, text) {
      const el = document.getElementById(id);
      el.textContent += text + "\n";
      el.scrollTop = el.scrollHeight;
    }

    function logToAll(text) {
      log("general-log", text);
      log("command-log", text);
      log("alert-log", text);
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(`${tabId}-tab`).classList.remove('hidden');
    }

    function exportLogs() {
      const format = document.getElementById('file-format').value;
      const logs = {
        general: document.getElementById('general-log').textContent.trim(),
        command: document.getElementById('command-log').textContent.trim(),
        alert: document.getElementById('alert-log').textContent.trim()
      };

      let content = "";
      if (format === "csv") {
        content = "Type,Message\n";
        content += logs.general.split('\n').map(l => `General,"${l}"`).join('\n') + '\n';
        content += logs.command.split('\n').map(l => `Command,"${l}"`).join('\n') + '\n';
        content += logs.alert.split('\n').map(l => `Alert,"${l}"`).join('\n');
      } else {
        content = `=== General ===\n${logs.general}\n\n=== Commands ===\n${logs.command}\n\n=== Alerts ===\n${logs.alert}`;
      }

      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `mqtt_log.${format}`;
      link.click();
    }

    function sendEmail() {
      const userEmail = document.getElementById('user-email').value;
      if (!userEmail) return alert("❗ Please enter your email address.");

      const fullLog =
        "=== General Logs ===\n" + document.getElementById('general-log').textContent.trim() + "\n\n" +
        "=== Command Logs ===\n" + document.getElementById('command-log').textContent.trim() + "\n\n" +
        "=== Alert Logs ===\n" + document.getElementById('alert-log').textContent.trim();

      const form = document.getElementById('email-form');
      form.title.value = "MQTT Report";
      form.name.value = "USF Harmar Dashboard";
      form.time.value = new Date().toLocaleString();
      form.message.value = fullLog;
      form.to_email.value = userEmail;

      emailjs.sendForm("service_lsa1r4i", "template_vnrbr1d", "#email-form")
        .then(() => {
          alert("✅ Report sent!");
        })
        .catch(err => {
          console.error("EmailJS Error:", err);
          alert("❌ Failed to send email.");
        });
    }

    const langMap = {
      en: {
        dashboardTitle: "USF Harmar MQTT Dashboard",
        general: "General Console",
        commands: "Command Console",
        alerts: "Alert Console",
        login: "Login",
        sendReport: "Send Report",
        exportLogs: "Export Logs"
      },
      es: {
        dashboardTitle: "Panel MQTT de USF Harmar",
        general: "Consola General",
        commands: "Consola de Comandos",
        alerts: "Consola de Alertas",
        login: "Iniciar sesión",
        sendReport: "Enviar Informe",
        exportLogs: "Exportar Registros"
      }
    };

    function switchLanguage() {
      const lang = document.getElementById("language-selector").value;
      document.querySelector(".nav-title").textContent = langMap[lang].dashboardTitle;
      document.querySelector("#general-tab h2").textContent = "📋 " + langMap[lang].general;
      document.querySelector("#commands-tab h2").textContent = "🧠 " + langMap[lang].commands;
      document.querySelector("#alerts-tab h2").textContent = "🚨 " + langMap[lang].alerts;
      document.querySelector("button[onclick='sendEmail()']").textContent = "📤 " + langMap[lang].sendReport;
      document.querySelector("button[onclick='exportLogs()']").textContent = "💾 " + langMap[lang].exportLogs;
    }

    window.addEventListener("DOMContentLoaded", () => {
      if (typeof emailjs !== "undefined") {
        emailjs.init("7osg1XmfdRC2z68Xt");
      } else {
        console.error("❌ EmailJS SDK not loaded.");
      }
    });
  </script>
</body>
</html>
